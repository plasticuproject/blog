<!DOCTYPE html>
<html lang="en-us">
<head>
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-50Z66QSKH7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-50Z66QSKH7');
</script>

    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="plasticuproject">
<meta name="description" content="Self Promoting Blog">
<meta name="generator" content="Hugo 0.92.2" />
<title>corCTF2024 lights-out</title>
<link rel="shortcut icon" href="https://plasticuproject.com/images/favicon.ico">
<link rel="stylesheet" href="https://plasticuproject.com/css/style.css">
<link rel="stylesheet" href="https://plasticuproject.com/css/highlight.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link href="https://plasticuproject.com/index.xml" rel="alternate" type="application/rss+xml" title="plasticuproject&#39;s blog" />


<meta property="og:title" content="corCTF2024 lights-out" />
<meta property="og:description" content="Solution to corCTF2024 misc challenge &#34;lights-out&#34; using linear algebra." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://plasticuproject.com/posts/lights_out/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-30T00:00:00+00:00" />



<meta itemprop="name" content="corCTF2024 lights-out">
<meta itemprop="description" content="Solution to corCTF2024 misc challenge &#34;lights-out&#34; using linear algebra."><meta itemprop="datePublished" content="2024-07-30T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-07-30T00:00:00+00:00" />
<meta itemprop="wordCount" content="1720">
<meta itemprop="keywords" content="corCTF,Write-Up,Python," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="corCTF2024 lights-out"/>
<meta name="twitter:description" content="Solution to corCTF2024 misc challenge &#34;lights-out&#34; using linear algebra."/>


</head>
<body>
    <nav class="main-nav">
	
		<a href='https://plasticuproject.com'>Posts</a>
	

	
 		<a href='/about/'>About</a>
  	

    <a href='https://plasticuproject.com/tags'>Tags</a>

	
		<a href="https://plasticuproject.com/index.xml">RSS</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>corCTF2024 lights-out</h1>
        <h2 class="subtitle">Solution to corCTF2024 misc challenge &ldquo;lights-out&rdquo; using linear algebra.</h2>
        <h2 class="headline">
        July 30, 2024
        <br>
          
            
              
              <a href="https://plasticuproject.com/tags/corctf">corCTF</a>
            
               | 
              <a href="https://plasticuproject.com/tags/write-up">Write-Up</a>
            
               | 
              <a href="https://plasticuproject.com/tags/python">Python</a>
            
          
        </h2>
    </header>
    <section id="post-body">
        <p><img src="/images/lights_out/cor.jpg#center" alt="Image"></p>
<hr>
<h2 id="the-challenge">The Challenge</h2>
<p><img src="/images/lights_out/challenge.png#center" alt="Image"></p>
<p>When we connect to the server, we are presented with some information about the game, how to play, an example, and the game board we need to solve. The game is pretty simple: the board is an N x N grid where we need to turn off all the &ldquo;lights&rdquo; by flipping, or not flipping, each position. The trick is that each time we modify a position, the adjacent positions will flip as well. The source code for the challenge was provided, but we will ignore that as it was unintinded. I know this because I&rsquo;m the author of this challenge and was pissed when strellic accidentally included it as a download with the challenge. Arg.</p>
<p><img src="/images/lights_out/console.png#center" alt="Image"></p>
<p>If we send an incorrect solution, a new game board is generated.</p>
<p><img src="/images/lights_out/wrong.png#center" alt="Image"></p>
<p>After about 10 seconds, if you did not submit a solution, the game would time out and generate a new board. At least, this is how the challenge was supposed to work. Strellic reworked the code so that it would work for a redpwn jailed instance instead of a team instancer as I had intended, so instead it just shit the bed after 30 seconds and made you reconnect. This is what you were supposed to see:</p>
<p><img src="/images/lights_out/timeout.png#center" alt="Image"></p>
<p>So we need to find a solution to the board very quickly and send that to the server to solve the challenge.</p>
<hr>
<h2 id="research">Research</h2>
<p>I am not a math wizard, but searching online I found that an optimal solution for certain Lights Out boards can be found by creating a linear algebra system and performing simple row operations. <a href="https://raw.org/research/solving-lightsout-using-linear-algebra/">Solving LightsOut using Linear Algebra</a> is a great breakdown of the problem. We can represent each position of our board in a vector/array using binary values, <em>0</em> for off, and <em>1</em> for on. We then use <a href="https://www.csus.edu/indiv/p/pangj/166/f/d8/5_Modulo%202%20Arithmetic.pdf">mod 2 addition</a> on each position, representing a position flip, to create a matrix of all position flips.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_vector_representations</span>(n: int) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Create vector representations for each position on the n x n board.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        n (int): The size of the board (n x n).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: A list of vectors representing the effect of
</span><span style="color:#e6db74">                           toggling each light.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    vectors <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n <span style="color:#f92672">*</span> n):
        vector <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (n <span style="color:#f92672">*</span> n)
        vector[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> n <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            vector[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># left</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> n <span style="color:#f92672">!=</span> n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
            vector[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># right</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;=</span> n:
            vector[i <span style="color:#f92672">-</span> n] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># up</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> n <span style="color:#f92672">*</span> (n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
            vector[i <span style="color:#f92672">+</span> n] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># down</span>
        vectors<span style="color:#f92672">.</span>append(vector)
    <span style="color:#66d9ef">return</span> vectors
</code></pre></div><p>Then we create an <a href="https://en.wikipedia.org/wiki/Augmented_matrix">augmented matrix</a> using that matrix and the board state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_augmented_matrix</span>(vectors: list[list[int]],
                            board: list[int]) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Create an augmented matrix from the vectors and board state.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        vectors (list[list[int]]): The vector representations.
</span><span style="color:#e6db74">        board (list[int]): The current state of the board.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: The augmented matrix.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    matrix <span style="color:#f92672">=</span> [vec <span style="color:#f92672">+</span> [board[i]] <span style="color:#66d9ef">for</span> i, vec <span style="color:#f92672">in</span> enumerate(vectors)]
    <span style="color:#66d9ef">return</span> matrix
</code></pre></div><p>Next, we preform <a href="https://raw.org/book/linear-algebra/gauss-jordan-elimination/">Gauss-Jordan Elimination</a> on the given matrix to produce its <a href="https://en.wikipedia.org/wiki/Row_echelon_form#Reduced_row_echelon_form">Reduced Row Echelon Form</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gauss_jordan_elimination</span>(matrix: list[list[int]]) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Perform Gauss-Jordan elimination on the given matrix to produce its
</span><span style="color:#e6db74">    Reduced Row Echelon Form (RREF).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        matrix (list[list[int]]): The matrix to be reduced.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: The matrix in RREF.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    rows, cols <span style="color:#f92672">=</span> len(matrix), len(matrix[<span style="color:#ae81ff">0</span>])
    r <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> range(cols <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">&gt;=</span> rows:
            <span style="color:#66d9ef">break</span>
        pivot <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(r, rows):
            <span style="color:#66d9ef">if</span> matrix[i][c] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                pivot <span style="color:#f92672">=</span> i
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">if</span> pivot <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">!=</span> pivot:
            matrix[r], matrix[pivot] <span style="color:#f92672">=</span> matrix[pivot], matrix[r]
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(rows):
            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> r <span style="color:#f92672">and</span> matrix[i][c] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(cols):
                    matrix[i][j] <span style="color:#f92672">^=</span> matrix[r][j]
        r <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> matrix
</code></pre></div><p>For good measure, we will check to make sure our augmented matrix is solvable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_solvable</span>(matrix: list[list[int]]) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Check if the given augmented matrix represents a solvable system.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        matrix (list[list[int]]): The augmented matrix.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        bool: True if the system is solvable, False otherwise.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    rref <span style="color:#f92672">=</span> gauss_jordan_elimination(matrix)
    <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rref:
        <span style="color:#66d9ef">if</span> row[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> all(val <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> val <span style="color:#f92672">in</span> row[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]):
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>

</code></pre></div><p>Finally, we will put it all together, creating our linear system and performing our operations to return our solution as a vector/array.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_solution</span>(board: list[int], n: int) <span style="color:#f92672">-&gt;</span> list[int] <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Get a solution for the Lights Out board if it exists.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        board (list[int]): The current state of the board.
</span><span style="color:#e6db74">        n (int): The size of the board (n x n).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[int] | None: A list representing the solution, or None
</span><span style="color:#e6db74">                            if no solution exists.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    vectors <span style="color:#f92672">=</span> create_vector_representations(n)
    matrix <span style="color:#f92672">=</span> create_augmented_matrix(vectors, board)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_solvable(matrix):
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
    rref_matrix <span style="color:#f92672">=</span> gauss_jordan_elimination(matrix)
    <span style="color:#66d9ef">return</span> [row[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rref_matrix[:n <span style="color:#f92672">*</span> n]]
</code></pre></div><p>Here is a great <a href="https://youtu.be/1izbpSk3ays?si=6j2VksbgejLRrCJK">video</a> that explains and visualizes the process.</p>
<hr>
<h2 id="scripting">Scripting</h2>
<p>To solve the challenge, we need to connect to the server via TCP, find the latest board characters, and convert them to an array of <em>0</em>s and <em>1</em>s. Then we can pass that array to our <strong>get_solution</strong> function, convert the resulting array into a string using the <em>.</em> and <em>#</em> characters, send that to the server, then retrieve and print our flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> socket


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect_to_server</span>(host: str, port: int) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Connects to a server, reads the Lights Out board,
</span><span style="color:#e6db74">    solves it, sends the solution back, then retrieves
</span><span style="color:#e6db74">    and prints the flag.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        host (str): The server&#39;s hostname or IP address.
</span><span style="color:#e6db74">        port (int): The server&#39;s port number.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        None
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">with</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM) <span style="color:#66d9ef">as</span> s:
        s<span style="color:#f92672">.</span>connect((host, port))
        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connected to server at </span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

        <span style="color:#66d9ef">try</span>:
            buffer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
            <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
                data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(
                    <span style="color:#e6db74">&#34;utf-8&#34;</span>)  <span style="color:#75715e"># Read data from the server</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data:
                    <span style="color:#66d9ef">break</span>
                buffer <span style="color:#f92672">+=</span> data

                <span style="color:#75715e"># Extract the board from the received data</span>
                matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(
                    <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;Lights Out Board:\n\n([\s\S]*?)\n\nYour Solution: &#34;</span>,
                    buffer)
                <span style="color:#66d9ef">if</span> matches:
                    board_str <span style="color:#f92672">=</span> matches[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
                    n <span style="color:#f92672">=</span> len(board_str<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>))
                    board <span style="color:#f92672">=</span> [
                        <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> char <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> board_str
                        <span style="color:#66d9ef">if</span> char <span style="color:#f92672">in</span> <span style="color:#e6db74">&#34;#.&#34;</span>
                    ]

                    <span style="color:#75715e"># Solve the Lights Out board</span>
                    solution <span style="color:#f92672">=</span> get_solution(board, n)

                    <span style="color:#75715e"># Convert solution back to # and .</span>
                    <span style="color:#66d9ef">if</span> solution:
                        solution_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#66d9ef">if</span> val <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;.&#34;</span>
                                               <span style="color:#66d9ef">for</span> val <span style="color:#f92672">in</span> solution)

                        <span style="color:#75715e"># Send the solution back to the server</span>
                        s<span style="color:#f92672">.</span>sendall((solution_str <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>))

                        <span style="color:#75715e"># Get and print flag</span>
                        flag <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
                        print(flag)

                    <span style="color:#75715e"># Exit the loop after retrieving the flag</span>
                    <span style="color:#66d9ef">break</span>

        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
            print(<span style="color:#e6db74">&#34;Connection closed by user.&#34;</span>)
        <span style="color:#66d9ef">finally</span>:
            s<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    SERVER_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;be.ax&#34;</span>
    SERVER_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">32421</span>
    connect_to_server(SERVER_HOST, SERVER_PORT)

</code></pre></div><hr>
<h2 id="full-solution">Full Solution</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#34;&#34;&#34;lights_out_solution.py&#34;&#34;&#34;</span>
<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> socket


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_vector_representations</span>(n: int) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Create vector representations for each position on the n x n board.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        n (int): The size of the board (n x n).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: A list of vectors representing the effect of
</span><span style="color:#e6db74">                           toggling each light.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    vectors <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n <span style="color:#f92672">*</span> n):
        vector <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (n <span style="color:#f92672">*</span> n)
        vector[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> n <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            vector[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># left</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> n <span style="color:#f92672">!=</span> n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
            vector[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># right</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;=</span> n:
            vector[i <span style="color:#f92672">-</span> n] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># up</span>
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> n <span style="color:#f92672">*</span> (n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
            vector[i <span style="color:#f92672">+</span> n] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># down</span>
        vectors<span style="color:#f92672">.</span>append(vector)
    <span style="color:#66d9ef">return</span> vectors


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_augmented_matrix</span>(vectors: list[list[int]],
                            board: list[int]) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Create an augmented matrix from the vectors and board state.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        vectors (list[list[int]]): The vector representations.
</span><span style="color:#e6db74">        board (list[int]): The current state of the board.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: The augmented matrix.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    matrix <span style="color:#f92672">=</span> [vec <span style="color:#f92672">+</span> [board[i]] <span style="color:#66d9ef">for</span> i, vec <span style="color:#f92672">in</span> enumerate(vectors)]
    <span style="color:#66d9ef">return</span> matrix


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gauss_jordan_elimination</span>(matrix: list[list[int]]) <span style="color:#f92672">-&gt;</span> list[list[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Perform Gauss-Jordan elimination on the given matrix to produce its
</span><span style="color:#e6db74">    Reduced Row Echelon Form (RREF).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        matrix (list[list[int]]): The matrix to be reduced.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[list[int]]: The matrix in RREF.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    rows, cols <span style="color:#f92672">=</span> len(matrix), len(matrix[<span style="color:#ae81ff">0</span>])
    r <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> range(cols <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">&gt;=</span> rows:
            <span style="color:#66d9ef">break</span>
        pivot <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(r, rows):
            <span style="color:#66d9ef">if</span> matrix[i][c] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                pivot <span style="color:#f92672">=</span> i
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">if</span> pivot <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">!=</span> pivot:
            matrix[r], matrix[pivot] <span style="color:#f92672">=</span> matrix[pivot], matrix[r]
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(rows):
            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> r <span style="color:#f92672">and</span> matrix[i][c] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(cols):
                    matrix[i][j] <span style="color:#f92672">^=</span> matrix[r][j]
        r <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> matrix


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_solvable</span>(matrix: list[list[int]]) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Check if the given augmented matrix represents a solvable system.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        matrix (list[list[int]]): The augmented matrix.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        bool: True if the system is solvable, False otherwise.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    rref <span style="color:#f92672">=</span> gauss_jordan_elimination(matrix)
    <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rref:
        <span style="color:#66d9ef">if</span> row[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> all(val <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> val <span style="color:#f92672">in</span> row[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]):
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_solution</span>(board: list[int], n: int) <span style="color:#f92672">-&gt;</span> list[int] <span style="color:#f92672">|</span> <span style="color:#66d9ef">None</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Get a solution for the Lights Out board if it exists.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        board (list[int]): The current state of the board.
</span><span style="color:#e6db74">        n (int): The size of the board (n x n).
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        list[int] | None: A list representing the solution, or None
</span><span style="color:#e6db74">                            if no solution exists.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    vectors <span style="color:#f92672">=</span> create_vector_representations(n)
    matrix <span style="color:#f92672">=</span> create_augmented_matrix(vectors, board)
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_solvable(matrix):
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
    rref_matrix <span style="color:#f92672">=</span> gauss_jordan_elimination(matrix)
    <span style="color:#66d9ef">return</span> [row[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rref_matrix[:n <span style="color:#f92672">*</span> n]]


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect_to_server</span>(host: str, port: int) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Connects to a server, reads the Lights Out board,
</span><span style="color:#e6db74">    solves it, sends the solution back, then retrieves
</span><span style="color:#e6db74">    and prints the flag.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">        host (str): The server&#39;s hostname or IP address.
</span><span style="color:#e6db74">        port (int): The server&#39;s port number.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        None
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">with</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM) <span style="color:#66d9ef">as</span> s:
        s<span style="color:#f92672">.</span>connect((host, port))
        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connected to server at </span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

        <span style="color:#66d9ef">try</span>:
            buffer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
            <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
                data <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(
                    <span style="color:#e6db74">&#34;utf-8&#34;</span>)  <span style="color:#75715e"># Read data from the server</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data:
                    <span style="color:#66d9ef">break</span>
                buffer <span style="color:#f92672">+=</span> data

                <span style="color:#75715e"># Extract the board from the received data</span>
                matches <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(
                    <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;Lights Out Board:\n\n([\s\S]*?)\n\nYour Solution: &#34;</span>,
                    buffer)
                <span style="color:#66d9ef">if</span> matches:
                    board_str <span style="color:#f92672">=</span> matches[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
                    n <span style="color:#f92672">=</span> len(board_str<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>))
                    board <span style="color:#f92672">=</span> [
                        <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> char <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> board_str
                        <span style="color:#66d9ef">if</span> char <span style="color:#f92672">in</span> <span style="color:#e6db74">&#34;#.&#34;</span>
                    ]

                    <span style="color:#75715e"># Solve the Lights Out board</span>
                    solution <span style="color:#f92672">=</span> get_solution(board, n)

                    <span style="color:#75715e"># Convert solution back to # and .</span>
                    <span style="color:#66d9ef">if</span> solution:
                        solution_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#66d9ef">if</span> val <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;.&#34;</span>
                                               <span style="color:#66d9ef">for</span> val <span style="color:#f92672">in</span> solution)

                        <span style="color:#75715e"># Send the solution back to the server</span>
                        s<span style="color:#f92672">.</span>sendall((solution_str <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>))

                        <span style="color:#75715e"># Get and print flag</span>
                        flag <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
                        print(flag)

                    <span style="color:#75715e"># Exit the loop after retrieving the flag</span>
                    <span style="color:#66d9ef">break</span>

        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
            print(<span style="color:#e6db74">&#34;Connection closed by user.&#34;</span>)
        <span style="color:#66d9ef">finally</span>:
            s<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    SERVER_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;be.ax&#34;</span>
    SERVER_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">32421</span>
    connect_to_server(SERVER_HOST, SERVER_PORT)
</code></pre></div><p>We run our program and are greeted with the flag.</p>
<p><img src="/images/lights_out/flag.png#center" alt="Image"></p>
<hr>

    </section>
</article>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "plasticuproject-github-io-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        <footer id="footer">
    
        <div id="social">

	
	
    <a rel="me" class="symbol" href="https://www.github.com/plasticuproject">
        <i class="fa-brands fa-github"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://fosstodon.org/@plasticuproject">
        <i class="fa-brands fa-mastodon"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://pypi.org/user/plasticuproject">
        <i class="fa-brands fa-python"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://cryptohack.org/user/snuggles">
        <i class="fa-solid fa-brain"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://leetcode.com/plasticuproject">
        <i class="fa-solid fa-code"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://app.hackthebox.com/profile/32882">
        <i class="fa-solid fa-cube"></i>
    </a>
    
    <a rel="me" class="symbol" href="mailto:plastic@plasticuproject.com">
        <i class="fa-solid fa-envelope"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://plasticuproject.com/fingerprint.txt">
        <i class="fa-solid fa-fingerprint"></i>
    </a>
    
    <a rel="me" class="symbol" href="https://plasticuproject.com/pubkey.txt">
        <i class="fa-solid fa-key"></i>
    </a>
    


</div>

    
    <p class="small">
    
        © Copyright 2024 plasticuproject
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://plasticuproject.com/js/main.js"></script>
<script src="https://plasticuproject.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
