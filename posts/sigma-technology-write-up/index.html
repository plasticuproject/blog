<!DOCTYPE html>
<html lang="en-us">
<head>
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-50Z66QSKH7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-50Z66QSKH7');
</script>

    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="plasticuproject">
<meta name="description" content="Self Promoting Blog">
<meta name="generator" content="Hugo 0.70.0" />
<title>HackTheBox Sigma Technology Write-Up</title>
<link rel="shortcut icon" href="https://plasticuproject.com/images/favicon.ico">
<link rel="stylesheet" href="https://plasticuproject.com/css/style.css">
<link rel="stylesheet" href="https://plasticuproject.com/css/highlight.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">



<link href="https://plasticuproject.com/index.xml" rel="alternate" type="application/rss+xml" title="plasticuproject&#39;s blog" />


<meta property="og:title" content="HackTheBox Sigma Technology Write-Up" />
<meta property="og:description" content="Sigma Technology is a medium difficulty misc challenge where we &#34;fool&#34; an image classifier into labeling an image of a dog as an airplane by only altering five individual pixels." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://plasticuproject.com/posts/sigma-technology-write-up/" />
<meta property="article:published_time" content="2022-11-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-11-12T00:00:00+00:00" />


<meta itemprop="name" content="HackTheBox Sigma Technology Write-Up">
<meta itemprop="description" content="Sigma Technology is a medium difficulty misc challenge where we &#34;fool&#34; an image classifier into labeling an image of a dog as an airplane by only altering five individual pixels.">
<meta itemprop="datePublished" content="2022-11-12T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-11-12T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1699">



<meta itemprop="keywords" content="HTB,Write-Up,Python,Misc," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HackTheBox Sigma Technology Write-Up"/>
<meta name="twitter:description" content="Sigma Technology is a medium difficulty misc challenge where we &#34;fool&#34; an image classifier into labeling an image of a dog as an airplane by only altering five individual pixels."/>


</head>
<body>
    <nav class="main-nav">
	
		<a href='https://plasticuproject.com'>Posts</a>
	

	
 		<a href='/about/'>About</a>
  	

    <a href='https://plasticuproject.com/tags'>Tags</a>

	
		<a href="https://plasticuproject.com/index.xml">RSS</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>HackTheBox Sigma Technology Write-Up</h1>
        <h2 class="subtitle">Sigma Technology is a medium difficulty misc challenge where we &ldquo;fool&rdquo; an image classifier into labeling an image of a dog as an airplane by only altering five individual pixels.</h2>
        <h2 class="headline">
        November 12, 2022
        <br>
          
            
              
              <a href="https://plasticuproject.com/tags/htb">HTB</a>
            
               | 
              <a href="https://plasticuproject.com/tags/write-up">Write-Up</a>
            
               | 
              <a href="https://plasticuproject.com/tags/python">Python</a>
            
               | 
              <a href="https://plasticuproject.com/tags/misc">Misc</a>
            
          
        </h2>
    </header>
    <section id="post-body">
        <p><img src="/images/console/Hack-The-Box-logo.png#center" alt=""></p>
<hr>
<h2 id="getting-started">Getting Started</h2>
<p><img src="/images/sigma_technology/pics/1.png#center" alt=""></p>
<p>We launch the challenge instance and are instructed to download <strong>Sigma_Technology.zip</strong>. We are also given the IP address/port number <strong>167.99.89.94:31617</strong>. The zipped file contains <strong>sigmanet.h5</strong>, a <a href="https://en.wikipedia.org/wiki/Hierarchical_Data_Format">Hierarchical Data Format</a>, as well as <strong>model.py</strong>, a python file which contains the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> tensorflow.keras.models <span style="color:#f92672">import</span> load_model

class_names <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;airplane&#39;</span>, <span style="color:#e6db74">&#39;automobile&#39;</span>, <span style="color:#e6db74">&#39;bird&#39;</span>, <span style="color:#e6db74">&#39;cat&#39;</span>, <span style="color:#e6db74">&#39;deer&#39;</span>, <span style="color:#e6db74">&#39;dog&#39;</span>, <span style="color:#e6db74">&#39;frog&#39;</span>, <span style="color:#e6db74">&#39;horse&#39;</span>,
    <span style="color:#e6db74">&#39;ship&#39;</span>, <span style="color:#e6db74">&#39;truck&#39;</span>
]

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SigmaNet</span>:
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sigmanet&#39;</span>
        self<span style="color:#f92672">.</span>model_filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sigmanet.h5&#39;</span>
        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>_model <span style="color:#f92672">=</span> load_model(self<span style="color:#f92672">.</span>model_filename)
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Successfully loaded&#39;</span>, self<span style="color:#f92672">.</span>name)
        <span style="color:#66d9ef">except</span> (<span style="color:#a6e22e">ImportError</span>, <span style="color:#a6e22e">ValueError</span>, <span style="color:#a6e22e">OSError</span>):
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Failed to load&#39;</span>, self<span style="color:#f92672">.</span>name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">color_process</span>(self, imgs):
        <span style="color:#66d9ef">if</span> imgs<span style="color:#f92672">.</span>ndim <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>:
            imgs <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([imgs])
        imgs <span style="color:#f92672">=</span> imgs<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
        mean <span style="color:#f92672">=</span> [<span style="color:#ae81ff">125.307</span>, <span style="color:#ae81ff">122.95</span>, <span style="color:#ae81ff">113.865</span>]
        std <span style="color:#f92672">=</span> [<span style="color:#ae81ff">62.9932</span>, <span style="color:#ae81ff">62.0887</span>, <span style="color:#ae81ff">66.7048</span>]
        <span style="color:#66d9ef">for</span> img <span style="color:#f92672">in</span> imgs:
            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span>):
                img[:, :, i] <span style="color:#f92672">=</span> (img[:, :, i] <span style="color:#f92672">-</span> mean[i]) <span style="color:#f92672">/</span> std[i]
        <span style="color:#66d9ef">return</span> imgs

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict</span>(self, img):
        processed <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>color_process(img)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_model<span style="color:#f92672">.</span>predict(processed)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_one</span>(self, img):
        confidence <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>predict(img)[<span style="color:#ae81ff">0</span>]
        predicted_class <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(confidence)
        <span style="color:#66d9ef">return</span> class_names[predicted_class]
</code></pre></div><p>Visiting the address/port given to us in the browser displays this webpage:
<img src="/images/sigma_technology/pics/2.png#center" alt=""></p>
<p>Based on the challenge description, files and webpage, we know that the webapp is using an image classifier to label the image of the dog, and we can assume that <strong>sigmanet.h5</strong> contains the <a href="https://www.tensorflow.org/guide/keras/save_and_serialize">Keras</a> model&rsquo;s architecture for that classifier. We will also assume that <strong>model.py</strong> is the code that is used to process and label images with this model.</p>
<p>We know that we need to &ldquo;fool&rdquo; the classifier into thinking this picture of a dog is another object by altering some of the image&rsquo;s pixel values. The webapp allows us to alter the red/green/blue values, in an (x,y) coordinate system, for five different pixels. Let&rsquo;s send some test changes through the webapp to see what happens and how it works.
<img src="/images/sigma_technology/pics/3.png#center" alt=""></p>
<p>The classifier still labeled the image as a dog, but we were able to find out how the webapp works and how our data is being sent. It is sending a <strong>POST</strong> request to the endpoint <strong>/point-laser</strong> with the new pixel values as <strong>form data</strong> in <strong>JSON</strong> format.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;p1&#34;</span>: <span style="color:#e6db74">&#34;1,+1,+1,+1,+1&#34;</span>,
  <span style="color:#f92672">&#34;p2&#34;</span>: <span style="color:#e6db74">&#34;2,+2,+2,+2,+2&#34;</span>,
  <span style="color:#f92672">&#34;p3&#34;</span>: <span style="color:#e6db74">&#34;3,+3,+3,+3,+3&#34;</span>,
  <span style="color:#f92672">&#34;p4&#34;</span>: <span style="color:#e6db74">&#34;4,+4,+4,+4,+4&#34;</span>,
  <span style="color:#f92672">&#34;p5&#34;</span>: <span style="color:#e6db74">&#34;5,+5,+5,+5,+5&#34;</span>
}
</code></pre></div><p>We can use this information to write a python script to automate an attack and communicate with the webapp.</p>
<hr>
<h2 id="research">Research</h2>
<p>After digging around on the web for a few minutes I found the paper <a href="/images/sigma_technology/1710.08864v7.pdf">One Pixel Attack for Fooling Deep Neural Networks</a>.
<img src="/images/sigma_technology/pics/OPA.png#center" alt=""></p>
<p>The paper goes into a lot of detail, most of which is over my head, but what I took from it is that knowing the predicted probability labels for the image might be enough feedback for us to tailor an attack to fool the classifier. Because we have the model file and the code used to classify images, we can download the dog image, alter pixels and locally run the classifier on it while accessing the probability labels. We can randomly alter one pixel at a time, in a loop,  trying to bump the probability for a selected object to a desired amount, then move on to another pixel. Hopefully we can get the probability for our selected object higher than all the other objects in five pixel changes or less, fooling the classifier. We can then send our altered pixel values to the webapp and hopefully get the flag. <strong>This now becomes an optimization problem</strong>.</p>
<hr>
<h2 id="code-it-up">Code it up</h2>
<p>First let&rsquo;s set up a <a href="https://www.python.org">python3</a> environment with the dependencies we will need. Let&rsquo;s install <a href="https://requests.readthedocs.io/en/latest/">requests</a> for the webapp communication, <a href="https://www.tensorflow.org/">tensorflow-gpu</a> for accessing the classifier and model, and <a href="https://python-pillow.org/">pillow</a> for image processing via <a href="https://pypi.org/">PyPi</a>&lsquo;s <a href="https://pip.pypa.io/en/stable/">pip</a> command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">python -m pip install requests tensorflow-gpu pillow
</code></pre></div><p>We&rsquo;ll create the file <strong>solve.py</strong> and write a function to download the dog image. Next we&rsquo;ll write a function to choose a random pixel from the dog image (as a <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html">numpy array</a>), giving it random red/green/blue values, return the new image numpy array, and for logging/display purposes the pixels that have been  changed. We will also extend the <strong>SigmaNet</strong> class from <strong>model.py</strong> to override the <strong>predict_one()</strong> method so that it also returns the <strong>confidence</strong> (probability) values.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#34;&#34;&#34;solve.py&#34;&#34;&#34;</span>

<span style="color:#f92672">import</span> shutil
<span style="color:#f92672">import</span> json
<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Tuple, List, Dict
<span style="color:#f92672">from</span> os <span style="color:#f92672">import</span> system
<span style="color:#f92672">from</span> sys <span style="color:#f92672">import</span> exit <span style="color:#66d9ef">as</span> sys_exit
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> randint
<span style="color:#f92672">import</span> numpy
<span style="color:#f92672">import</span> numpy.typing <span style="color:#f92672">as</span> npt
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">from</span> model <span style="color:#f92672">import</span> SigmaNet, class_names

URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://167.99.89.94:31617&#34;</span>

<span style="color:#75715e"># Numpy types</span>
NDArrayInt <span style="color:#f92672">=</span> npt<span style="color:#f92672">.</span>NDArray[numpy<span style="color:#f92672">.</span>int_]
NDArrayFloat <span style="color:#f92672">=</span> npt<span style="color:#f92672">.</span>NDArray[numpy<span style="color:#f92672">.</span>float32]


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExtendsSigmaNet</span>(SigmaNet):
    <span style="color:#e6db74">&#34;&#34;&#34;Extends the model.py SigmaNet class.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_one</span>(self, img: NDArrayInt) <span style="color:#f92672">-&gt;</span> Tuple[str, NDArrayFloat]:
        <span style="color:#e6db74">&#34;&#34;&#34;Override SigmaNet().predict_one() method,
</span><span style="color:#e6db74">        adding confidence values in the return.&#34;&#34;&#34;</span>
        confidence <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>predict(img)[<span style="color:#ae81ff">0</span>]
        predicted_class <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>argmax(confidence)

        <span style="color:#66d9ef">return</span> (class_names[predicted_class], confidence)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download_image</span>() <span style="color:#f92672">-&gt;</span> None:
    <span style="color:#e6db74">&#34;&#34;&#34;Download dog image from server.&#34;&#34;&#34;</span>
    resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/static/dog.png&#34;</span>, stream<span style="color:#f92672">=</span>True, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>)
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;dog.png&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> outfile:
        shutil<span style="color:#f92672">.</span>copyfileobj(resp<span style="color:#f92672">.</span>raw, outfile)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">randomize</span>(narr: NDArrayInt) <span style="color:#f92672">-&gt;</span> Tuple[NDArrayInt, List[int]]:
    <span style="color:#e6db74">&#34;&#34;&#34;Randomize random pixel RGB value and save to
</span><span style="color:#e6db74">    new image numpy array.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns new image numpy array and new RGB values.&#34;&#34;&#34;</span>
    image: NDArrayInt <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>copy(narr)
    x_value <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">31</span>)
    y_value <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">31</span>)
    red <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)
    green <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)
    blue <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)
    image[x_value, y_value] <span style="color:#f92672">=</span> [red, green, blue]

    <span style="color:#66d9ef">return</span> (image, [x_value, y_value, red, green, blue])
</code></pre></div><p>Next we&rsquo;ll write our main attack loop function. The plan is to convert our image into a numpy array, then iteratively alter pixel values with <strong>randomize()</strong>, running the <strong>ExtendsSigmaNet().predict_one()</strong> method on the resulting numpy array, attempting to increase confidence for the <em>airplane</em> label by a non-trivial amount. We start with a high threshold for an acceptable confidence level and after roughly 100 attempts reduce that threshold with a decreasing <em>multiplier</em> value until a desired confidence level is met. We then save that result and restart the process until the image is classified as an <em>airplane</em>. We will display information for each attempt along the way to monitor our progress and finally return the total number of attempts, classifier result, new image numpy array and a list of changed pixels.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pylint: disable=too-many-locals</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">attack</span>() <span style="color:#f92672">-&gt;</span> Tuple[int, str, NDArrayInt, Dict[Tuple[int, int], List[int]]]:
    <span style="color:#e6db74">&#34;&#34;&#34;Performs a One Pixel Attack on dog image, five times,
</span><span style="color:#e6db74">    each time trying to increase the prediction confidence
</span><span style="color:#e6db74">    for &#34;airplane&#34;, until it&#39;s confidence is higher than any
</span><span style="color:#e6db74">    other object.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns number of change attempts, final/new image prediction,
</span><span style="color:#e6db74">    final/new image numpy array, and dict of changed pixels.&#34;&#34;&#34;</span>

    <span style="color:#75715e"># Convert image to numpy array</span>
    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;dog.png&#34;</span>)
    np_img <span style="color:#f92672">=</span> numpy<span style="color:#f92672">.</span>array(img)[:, :, :<span style="color:#ae81ff">3</span>]

    <span style="color:#75715e"># Initialization</span>
    count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    pixel_change <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    const <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
    multiplier <span style="color:#f92672">=</span> const
    visited: List[Tuple[int, int]] <span style="color:#f92672">=</span> []
    changes: Dict[Tuple[int, int], List[int]] <span style="color:#f92672">=</span> {}
    sig_net: ExtendsSigmaNet <span style="color:#f92672">=</span> ExtendsSigmaNet()
    guess <span style="color:#f92672">=</span> sig_net<span style="color:#f92672">.</span>predict_one(np_img)
    old_plane_val: numpy<span style="color:#f92672">.</span>float32 <span style="color:#f92672">=</span> guess[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
    target <span style="color:#f92672">=</span> old_plane_val <span style="color:#f92672">*</span> multiplier

    <span style="color:#75715e"># Attack loop</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">SCRIPT GO BRRRRRRRRRRRR...........</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    <span style="color:#66d9ef">while</span> guess[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;airplane&#34;</span> <span style="color:#f92672">and</span> pixel_change <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span>:
        system(<span style="color:#e6db74">&#34;clear&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">SCRIPT GO BRRRRRRRRRRRR...........</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)

        <span style="color:#75715e"># For every 100 runs, decrease the confidence multiplier</span>
        <span style="color:#75715e">#  by one, therefore decreasing the overall target plane</span>
        <span style="color:#75715e">#  confidence. This way we can optimize by trying to get</span>
        <span style="color:#75715e">#  the largest confidence change first (since our changes</span>
        <span style="color:#75715e">#  are pseudo-random), then slowly lower our expectations</span>
        <span style="color:#66d9ef">if</span> count <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">99</span>:
            multiplier <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>

        <span style="color:#75715e"># Generate new attempt</span>
        new <span style="color:#f92672">=</span> randomize(np_img)
        x_value, y_value, red, green, blue <span style="color:#f92672">=</span> new[<span style="color:#ae81ff">1</span>]
        guess <span style="color:#f92672">=</span> sig_net<span style="color:#f92672">.</span>predict_one(new[<span style="color:#ae81ff">0</span>])
        count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

        <span style="color:#75715e"># Print attempt info</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;ATTEMPT:&#34;</span>, count)
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;TRYING: {x_value, y_value} {list((red, green, blue))}&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;PLANE CONFIDENCE MULTIPLIER:&#34;</span>, multiplier)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;TARGET PLANE CONFIDENCE:&#34;</span>, target)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;PIXEL CHANGES:&#34;</span>, pixel_change)
        <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> changes<span style="color:#f92672">.</span>items():
            <span style="color:#66d9ef">print</span>(key, value)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;-----------------------&#34;</span>)
        <span style="color:#66d9ef">for</span> index, value <span style="color:#f92672">in</span> enumerate(guess[<span style="color:#ae81ff">1</span>]):
            <span style="color:#66d9ef">print</span>(class_names[index], value)
        <span style="color:#66d9ef">print</span>()

        <span style="color:#75715e"># New airplane confidence check</span>
        <span style="color:#66d9ef">if</span> guess[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&gt;=</span> target <span style="color:#f92672">or</span> guess[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;airplane&#34;</span>:

            <span style="color:#75715e"># Reset multiplier, save new image numpy array for next</span>
            <span style="color:#75715e">#  generation, record changed values and adjust new</span>
            <span style="color:#75715e">#  confidence target</span>
            multiplier <span style="color:#f92672">=</span> const
            np_img <span style="color:#f92672">=</span> new[<span style="color:#ae81ff">0</span>]
            <span style="color:#66d9ef">if</span> (x_value, y_value) <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> visited:
                visited<span style="color:#f92672">.</span>append((x_value, y_value))
                pixel_change <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            changes[(x_value, y_value)] <span style="color:#f92672">=</span> [red, green, blue]
            old_plane_val <span style="color:#f92672">=</span> guess[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
        target <span style="color:#f92672">=</span> old_plane_val <span style="color:#f92672">*</span> multiplier

    <span style="color:#66d9ef">return</span> (count, guess[<span style="color:#ae81ff">0</span>], new[<span style="color:#ae81ff">0</span>], changes)
</code></pre></div><p>Now that the heavy lifting is done and we have presumably fooled the local classifier, we create a function to convert our new image numpy array back into a png image and save it. We build our POST request with our pixel value changes, send that data to the webapp and display some information, including the raw webpage text returned from our request, hopefully containing the challenge flag.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_send_save</span>(count: int, guess: str, new: NDArrayInt,
                    changes: Dict[Tuple[int, int], List[int]]) <span style="color:#f92672">-&gt;</span> None:
    <span style="color:#e6db74">&#34;&#34;&#34;When defeated, save new image, print
</span><span style="color:#e6db74">    values and send data to server.&#34;&#34;&#34;</span>

    <span style="color:#75715e"># Save new image of dog that classifies as airplane</span>
    <span style="color:#66d9ef">if</span> guess <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;airplane&#34;</span>:
        not_dog <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>fromarray(new)
        not_dog<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#34;not_dog.png&#34;</span>)

        <span style="color:#75715e"># Print changed values and build request data string</span>
        <span style="color:#75715e">#  with changed values</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;DEFEATING PIXEL VALUES:&#34;</span>)
        data: Dict[str, str] <span style="color:#f92672">=</span> {}
        key_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> changes<span style="color:#f92672">.</span>items():
            p_value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([str(_) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,+&#34;</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> key])
            p_value <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(str(_) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;,+&#34;</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> value)
            data[<span style="color:#e6db74">&#34;p&#34;</span> <span style="color:#f92672">+</span> str(key_count)] <span style="color:#f92672">=</span> p_value[:<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
            key_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">print</span>(key, value)
        <span style="color:#66d9ef">if</span> len(data) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>:
            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(data) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>):
                data[<span style="color:#e6db74">&#34;p&#34;</span> <span style="color:#f92672">+</span> str(i)] <span style="color:#f92672">=</span> data[<span style="color:#e6db74">&#34;p1&#34;</span>]

        <span style="color:#75715e"># Write request data string of changed values to file</span>
        <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;defeating_values.txt&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">as</span> defeat:
            defeat<span style="color:#f92672">.</span>write(json<span style="color:#f92672">.</span>dumps(data))

        <span style="color:#75715e"># Print attempt information and request data string, or failure</span>
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        _r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(URL <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/point-laser&#34;</span>, data<span style="color:#f92672">=</span>data, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>)
        <span style="color:#66d9ef">print</span>(_r<span style="color:#f92672">.</span>text)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">ATTEMPT:&#34;</span>, count)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;GUESS:&#34;</span>, guess)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">FORM DATA:&#34;</span>, data)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">FAILED!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>Finally, we call our functions when the script is run.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#66d9ef">try</span>:
        download_image()
        print_send_save(<span style="color:#f92672">*</span>attack())
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
        sys_exit()
</code></pre></div><hr>
<h2 id="running-the-script">Running the Script</h2>
<p>Here is a screenshot of our running script as it tries to get the image classified as an airplane.
<img src="/images/sigma_technology/pics/4.png#center" alt=""></p>
<p>Our script has successfully fooled the local classifier within just a few minutes, in under 5k attempts.
<img src="/images/sigma_technology/pics/6.png#center" alt=""></p>
<p>It then sends the five pixel value changes to the webapp and returns the raw webpage text, which includes the challenge flag.
<img src="/images/sigma_technology/pics/7.png#center" alt=""></p>
<hr>
<h2 id="just-for-fun">Just for Fun</h2>
<p>We can also manually input the changes into the webapp through the browser and see the rendered webpage containing the flag.
<img src="/images/sigma_technology/pics/flag.png#center" alt=""></p>
<p>Then open the original dog image and the new &ldquo;airplane&rdquo; image to visually compare and see the differences.
<img src="/images/sigma_technology/pics/dog.png#center" alt=""></p>
<p><img src="/images/sigma_technology/pics/not_dog.png#center" alt=""></p>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>At the time of retirement this challenge only had 111 solves on HackTheBox. I&rsquo;m not sure if people found it too difficult, were scared off by the machine learning aspect, or were just uninterested in challenges of this nature. I found it to be relatively medium difficulty for a misc challenge by just brute-forcing with some slight optimization, and had fun while developing a solution.</p>
<hr>

    </section>
</article>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "plasticuproject-github-io-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://pypi.org/user/plasticuproject">
        <i class="fa fa-code"></i>
    </a>
    
    <a class="symbol" href="https://www.hackthebox.com/profile/32882">
        <i class="fa fa-cube"></i>
    </a>
    
    <a class="symbol" href="mailto:plastic@plasticuproject.com">
        <i class="fa fa-envelope"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/plasticuproject">
        <i class="fa fa-github"></i>
    </a>
    
    <a class="symbol" href="https://cryptohack.org/user/snuggles">
        <i class="fa fa-key"></i>
    </a>
    
    <a class="symbol" href="https://leetcode.com/plasticuproject">
        <i class="fa fa-terminal"></i>
    </a>
    


</div>

    
    <p class="small">
    
        © Copyright 2022 plasticuproject
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://plasticuproject.com/js/main.js"></script>
<script src="https://plasticuproject.com/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





</body>
</html>
