<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="plasticuproject">
<meta name="description" content="Self Promoting Blog">
<meta name="generator" content="Hugo 0.70.0" />
<title>CyberSecLabs Plastic Preservation Write-Up</title>
<link rel="shortcut icon" href="https://plasticuproject.github.io/blog/images/favicon.ico">
<link rel="stylesheet" href="https://plasticuproject.github.io/blog/css/style.css">
<link rel="stylesheet" href="https://plasticuproject.github.io/blog/css/highlight.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>

    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">



<link href="https://plasticuproject.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="plasticuproject&#39;s blog" />


<meta property="og:title" content="CyberSecLabs Plastic Preservation Write-Up" />
<meta property="og:description" content="Plastic Preservation is a CyberSecLabs challenge I created where we defeat an encryption function written in python." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://plasticuproject.github.io/blog/posts/plastic-preservation-write-up/" />
<meta property="article:published_time" content="2020-05-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-29T00:00:00+00:00" />


<meta itemprop="name" content="CyberSecLabs Plastic Preservation Write-Up">
<meta itemprop="description" content="Plastic Preservation is a CyberSecLabs challenge I created where we defeat an encryption function written in python.">
<meta itemprop="datePublished" content="2020-05-29T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-05-29T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1771">



<meta itemprop="keywords" content="CyberSecLabs,Write-Up,Python,Cryptography," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CyberSecLabs Plastic Preservation Write-Up"/>
<meta name="twitter:description" content="Plastic Preservation is a CyberSecLabs challenge I created where we defeat an encryption function written in python."/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='https://plasticuproject.github.io/blog/'>Home</a>
	

	
 		<a href='/blog/about/'>About</a>
  	

    <a href='https://plasticuproject.github.io/blog//tags'>Tags</a>

	
		<a href="https://plasticuproject.github.io/blog/index.xml">RSS</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>CyberSecLabs Plastic Preservation Write-Up</h1>
        <h2 class="subtitle">Plastic Preservation is a CyberSecLabs challenge I created where we defeat an encryption function written in python.</h2>
        <h2 class="headline">
        May 29, 2020
        <br>
          
            
              
              <a href="https://plasticuproject.github.io/blog/tags/cyberseclabs">CyberSecLabs</a>
            
               | 
              <a href="https://plasticuproject.github.io/blog/tags/write-up">Write-Up</a>
            
               | 
              <a href="https://plasticuproject.github.io/blog/tags/python">Python</a>
            
               | 
              <a href="https://plasticuproject.github.io/blog/tags/cryptography">Cryptography</a>
            
          
        </h2>
    </header>
    <section id="post-body">
        <p><figure><img src="/blog/images/shares/pics/CyberSecLabs.png#center" alt="CyberSecLabs"></figure></p>

<hr>

<h2 id="the-challenge">The Challenge</h2>

<p>After downloading and unpacking the archive, we initially see it contains a text file named <strong>encrypted.txt</strong>, a python script called <strong>password_encrypter.py</strong>, and a password protected zipped directory named <strong>flag.txt.zip</strong>, which contains the text file <strong>flag.txt</strong>. It's probably safe to assume that we need to discover a password to unlock flag.txt.zip and read flag.txt, which will contain the challenge flag.</p>

<p>Printing encrypted.txt reveals that it contains what is most likely a <strong>base-64</strong> string.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">YzQwZDFmMWI3YmRkNjAxMg<span style="color:#f92672">==</span></code></pre></div>
<p>Decoding this reveals what looks like a <strong>hexadecimal</strong> value:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">plasticuproject@UBOX:~$ echo <span style="color:#e6db74">&#34;YzQwZDFmMWI3YmRkNjAxMg==&#34;</span> | base64 -d
c40d1f1b7bdd6012</code></pre></div>
<p>Trying to converting this to <strong>ascii</strong> renders <strong>non-printable characters</strong>, and trying the base-64 string, hexadecimal, and decimal representations will not unlock the flag file. Let's move on and take a look at <strong>password_encrypter.py</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">import</span> base64
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">z</span>(v):
    a <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x2e\x6c\x6f\x67</span><span style="color:#e6db74">&#39;</span>
    <span style="color:#66d9ef">with</span> open(a, <span style="color:#e6db74">&#39;a&#39;</span>) <span style="color:#66d9ef">as</span> a:
        a<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;# {} {} </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(datetime<span style="color:#f92672">.</span>now(), v))


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">y</span>(a):
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xCBF29CE484222325</span>
    c <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;100000001B3&#39;</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> a:
        z(str(b))                          <span style="color:#75715e"># &lt;- #REMOVE#</span>
        b <span style="color:#f92672">=</span> b <span style="color:#f92672">^</span> ord(str(i)) <span style="color:#f92672">*</span> int(c, <span style="color:#ae81ff">16</span>)
    b <span style="color:#f92672">^=</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFFFF</span>
    d <span style="color:#f92672">=</span> str<span style="color:#f92672">.</span>encode(hex(b)[<span style="color:#ae81ff">2</span>:])
    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(d)<span style="color:#f92672">.</span>decode()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>():
    e <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#39;[*]Enter your password: &#39;</span>)
    f <span style="color:#f92672">=</span> y(e)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]Your encrypted password is: {}&#39;</span><span style="color:#f92672">.</span>format(f))
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]And has been saved to encrypted.txt&#39;</span>)
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;encrypted.txt&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> g:
        g<span style="color:#f92672">.</span>write(f)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    x()</code></pre></div>
<p>The first thing I notice about this script is that someone attempted to obfuscate some of this code. There are objects in here that are written in types to make this file harder to read, but otherwise do nothing else. Let's go ahead and rewrite this, trying to make it easier to read and make more sense:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">import</span> base64
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">z</span>(v):
    a <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.log&#39;</span> <span style="color:#75715e"># changed to UTF-8</span>
    <span style="color:#66d9ef">with</span> open(a, <span style="color:#e6db74">&#39;a&#39;</span>) <span style="color:#66d9ef">as</span> a:
        a<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;# {} {} </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(datetime<span style="color:#f92672">.</span>now(), v))


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">y</span>(a):
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">14695981039346656037</span> <span style="color:#75715e"># changed to int type</span>
    c <span style="color:#f92672">=</span> <span style="color:#ae81ff">1099511628211</span> <span style="color:#75715e"># changed to int type</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> a:
        z(str(b))                          <span style="color:#75715e"># &lt;- #REMOVE#</span>
        b <span style="color:#f92672">=</span> b <span style="color:#f92672">^</span> ord(str(i)) <span style="color:#f92672">*</span> c <span style="color:#75715e"># removed now unnecessary type conversion </span>
    b <span style="color:#f92672">^=</span> <span style="color:#ae81ff">1152921504606846975</span> <span style="color:#75715e"># changed to int type</span>
    d <span style="color:#f92672">=</span> str<span style="color:#f92672">.</span>encode(hex(b)[<span style="color:#ae81ff">2</span>:])
    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(d)<span style="color:#f92672">.</span>decode()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">x</span>():
    e <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#39;[*]Enter your password: &#39;</span>)
    f <span style="color:#f92672">=</span> y(e)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]Your encrypted password is: {}&#39;</span><span style="color:#f92672">.</span>format(f))
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]And has been saved to encrypted.txt&#39;</span>)
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;encrypted.txt&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> g:
        g<span style="color:#f92672">.</span>write(f)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    x()</code></pre></div>
<p>Next let's try to guess what some of these functions do and what these variables are, then give them proper names. We will add some comments to help us understand what this code is doing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">import</span> base64
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime

<span style="color:#75715e"># writes input log_value to &#39;.log&#39; file with timestamp</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_to_file</span>(log_value):
    file_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.log&#39;</span>
    <span style="color:#66d9ef">with</span> open(file_name, <span style="color:#e6db74">&#39;a&#39;</span>) <span style="color:#66d9ef">as</span> log_file:
        log_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;# {} {} </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(datetime<span style="color:#f92672">.</span>now(), log_value))


<span style="color:#75715e"># encrypts string</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(input_string):

    <span style="color:#75715e"># offset</span>
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">14695981039346656037</span>

    <span style="color:#75715e"># prime value</span>
    c <span style="color:#f92672">=</span> <span style="color:#ae81ff">1099511628211</span>

    <span style="color:#75715e"># for each character in input_string</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> input_string:

        <span style="color:#75715e"># writes new b value to &#39;.log&#39; file</span>
        log_to_file(str(b))                          <span style="color:#75715e"># &lt;- #REMOVE#</span>

        <span style="color:#75715e"># performs XOR on b and string value, MULTIPLIES with prime value and saves to new b</span>
        b <span style="color:#f92672">=</span> b <span style="color:#f92672">^</span> ord(str(i)) <span style="color:#f92672">*</span> c

    <span style="color:#75715e"># XOR b with this value after final character logic</span>
    b <span style="color:#f92672">^=</span> <span style="color:#ae81ff">1152921504606846975</span>

    <span style="color:#75715e"># convert result to hexadecimal </span>
    result <span style="color:#f92672">=</span> str<span style="color:#f92672">.</span>encode(hex(b)[<span style="color:#ae81ff">2</span>:])

    <span style="color:#75715e"># return base64 encoded hexadecimal result</span>
    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>b64encode(result)<span style="color:#f92672">.</span>decode()


<span style="color:#75715e"># main function</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():

    <span style="color:#75715e"># enter plaintext password</span>
    password <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#39;[*]Enter your password: &#39;</span>)

    <span style="color:#75715e"># encrypts password</span>
    encrypted_password <span style="color:#f92672">=</span> encrypt(password)

    <span style="color:#75715e"># prints encrypted password</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]Your encrypted password is: {}&#39;</span><span style="color:#f92672">.</span>format(encrypted_password))
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[*]And has been saved to encrypted.txt&#39;</span>)

    <span style="color:#75715e"># writes encrypted password to &#39;encrypted.txt&#39; file</span>
    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;encrypted.txt&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> encrypted_password_file:
        encrypted_password_file<span style="color:#f92672">.</span>write(encrypted_password)


<span style="color:#75715e"># runs main function when file is called</span>
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()</code></pre></div>
<p>Now it is much easier to understand what this script it doing! It appears to take a plaintext password, encrypts it with some logic, and returns a sort of base-64 encrypted value. One thing I noticed is what appears to be some debug logging code, where it writes to <strong>.log</strong> at each step of the function where it processes a new character, before the final XOR. We did not see this file the first time we looked because it is a <strong>dotfile</strong> and is hidden. Let's read the <strong>.log</strong> file and see what is inside of it:</p>
<pre><code># DEBUG VALUES
# 2020-05-21 18:03:15.119201 14695981039346656037 
# 2020-05-21 18:03:15.119397 14696061303695535806 
# 2020-05-21 18:03:15.119572 14696043711509479214 
# 2020-05-21 18:03:15.119720 14695985437393189345 
# 2020-05-21 18:03:15.119860 14696089890997852300 
# 2020-05-21 18:03:15.119998 14695972243253652829 
# 2020-05-21 18:03:15.120137 14696084393439713207 
# 2020-05-21 18:03:15.120273 14696031616881559079 
# 2020-05-21 18:03:15.120410 14696017323230383122 
# 2020-05-21 18:03:15.120544 14696058005160652159 
# 2020-05-21 18:03:15.120679 14695979939835027684 
# 2020-05-21 18:03:15.120813 14695997532021092724 
# 2020-05-21 18:03:15.120947 14696053607114127291 
# 2020-05-21 18:03:15.121079 14695998631532721677 
# 2020-05-21 18:03:15.121213 14696076696858318688 
# 2020-05-21 18:03:15.121347 14695953551555979568 
# 2020-05-21 18:03:15.121478 14696084393439700139 
# 2020-05-21 18:03:15.121608 14696034915416472030 
# 2020-05-21 18:03:15.121737 14695990934951315814 
# 2020-05-21 18:03:15.121864 14695973342765258998 
# 2020-05-21 18:03:15.121995 14696085492951327260 
# 2020-05-21 18:03:15.122126 14695989835439670129 
# 2020-05-21 18:03:15.122255 14696041512486226244 
# 2020-05-21 18:03:15.122389 14696055806137376749 
# 2020-05-21 18:03:15.122520 14695963447160612969</code></pre>
<p>We can see that when <strong>password_encrypter.py</strong> was last run, it wrote that <strong>b</strong> value to this file at every step of the encryption. Since there were no destructive operations in the function, and we have a newly created value at every step of the encryption saved, all information was preserved and we should be able to rewrite the function, feeding it the encrypted base-64 output as it's input and reversing the encryption logic using our debug values.</p>

<hr>

<h2 id="solve-script">Solve Script</h2>

<p>The first thing we will do is read those debug values from the <strong>.log</strong> file and place them in a list. We do that by writing code to read each line of the file, splitting that line into a list of four elements using a space as a delimiter, and appending the fourth element, the debug value, to a list. We will also import the <strong>base64</strong> module, as we will need it later. The code will look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> base64


<span style="color:#75715e"># list to hold our debug values</span>
debugs <span style="color:#f92672">=</span> []

<span style="color:#75715e"># open .log file</span>
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;.log&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> log_file:

    <span style="color:#75715e"># get each line from file</span>
    lines <span style="color:#f92672">=</span> log_file<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#75715e"># from each line except the first and last, which contain</span>
<span style="color:#75715e"># &#34;# DEBUG VALUES&#34; and an empty line, respectively</span>
<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> lines[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:

    <span style="color:#75715e"># place the fourth item, the debug value, into debug list</span>
    debugs<span style="color:#f92672">.</span>append(int(line<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">3</span>]))</code></pre></div>
<p>Now we will write our function to reverse the encryption. We will do this by feeding it our base-64 encrypted password, converting it back to an integer, and performing the encryption function logic to it in reverse using the values in our <strong>debug</strong> list. When we calculate each character we will save that to a list, building the original password backwards. When we are done we will reverse the order of this list, and we should have the original password that was fed into <strong>password_encrypter.py</strong> that produced the base-64 string in <strong>encrypted.txt</strong>. We will print that password and quit the program. Our decryption function looks as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># decryption function</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(passwd, debugs):

    <span style="color:#75715e"># where we store characters</span>
    solve <span style="color:#f92672">=</span> []

    <span style="color:#75715e"># seed value</span>
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">14695981039346656037</span>

    <span style="color:#75715e"># secret value</span>
    c <span style="color:#f92672">=</span> <span style="color:#ae81ff">1099511628211</span>

    <span style="color:#75715e"># convert password back to integer</span>
    passwd <span style="color:#f92672">=</span> int(base64<span style="color:#f92672">.</span>b64decode(str<span style="color:#f92672">.</span>encode(passwd))<span style="color:#f92672">.</span>decode(), <span style="color:#ae81ff">16</span>)

    <span style="color:#75715e"># final XOR becomes our first</span>
    passwd <span style="color:#f92672">^=</span> <span style="color:#ae81ff">1152921504606846975</span>

    <span style="color:#75715e"># append passwd integer to debug list</span>
    debugs<span style="color:#f92672">.</span>append(passwd)

    <span style="color:#75715e"># reverse debug list</span>
    debugs <span style="color:#f92672">=</span> debugs[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]

    <span style="color:#75715e"># append seed value to debug list</span>
    debugs<span style="color:#f92672">.</span>append(b)

    <span style="color:#75715e"># loop through debug list and perform reverse encryption logic</span>
    <span style="color:#75715e"># and append characters to character list</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(debugs) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
        solve<span style="color:#f92672">.</span>append(chr(int((debugs[i] <span style="color:#f92672">^</span> debugs[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> c)))

    <span style="color:#75715e"># put password in correct order, print and quit</span>
    <span style="color:#66d9ef">print</span>( <span style="color:#e6db74">&#39;PASSWORD: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(solve[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
    quit()</code></pre></div>
<p>Now at the bottom we will call the function with the base-64 string and debug values as arguments:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">decrypt(<span style="color:#e6db74">&#39;YzQwZDFmMWI3YmRkNjAxMg==&#39;</span>, debugs)</code></pre></div>
<p>This is what our full script will look like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> base64


<span style="color:#75715e"># list to hold our debug values</span>
debugs <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;.log&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> log_file:
    lines <span style="color:#f92672">=</span> log_file<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> lines[<span style="color:#ae81ff">1</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
    debugs<span style="color:#f92672">.</span>append(int(line<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">3</span>]))


<span style="color:#75715e"># decryption function</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(passwd, debugs):
    solve <span style="color:#f92672">=</span> []
    b <span style="color:#f92672">=</span> <span style="color:#ae81ff">14695981039346656037</span>
    c <span style="color:#f92672">=</span> <span style="color:#ae81ff">1099511628211</span>
    passwd <span style="color:#f92672">=</span> int(base64<span style="color:#f92672">.</span>b64decode(str<span style="color:#f92672">.</span>encode(passwd))<span style="color:#f92672">.</span>decode(), <span style="color:#ae81ff">16</span>)
    passwd <span style="color:#f92672">^=</span> <span style="color:#ae81ff">1152921504606846975</span>
    debugs<span style="color:#f92672">.</span>append(passwd)
    debugs <span style="color:#f92672">=</span> debugs[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
    debugs<span style="color:#f92672">.</span>append(b)
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(debugs) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
        solve<span style="color:#f92672">.</span>append(chr(int((debugs[i] <span style="color:#f92672">^</span> debugs[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> c)))
    <span style="color:#66d9ef">print</span>( <span style="color:#e6db74">&#39;PASSWORD: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(solve[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
    quit()


<span style="color:#66d9ef">print</span>(decrypt(<span style="color:#e6db74">&#39;YzQwZDFmMWI3YmRkNjAxMg==&#39;</span>, debugs))</code></pre></div>
<p>This will give us the following output:</p>
<pre><code>PASSWORD: y0u_kn0w_y0ur_py7h0n_w3ll</code></pre>
<p>We now have the original password that was fed into <strong>password_encrypter.py</strong> and can use it to unlock <strong>flag.txt.zip</strong>.</p>

<p><figure><img src="/blog/images/plastic_preservation/password.png" alt="password"></figure></p>

<p>We can now read <strong>flag.txt</strong> and solve the challenge.</p>

<p><figure><img src="/blog/images/plastic_preservation/flag.png" alt="flag"></figure></p>

<p>I designed this challenge in a way where you would really need to understand what the python code is doing in order to reverse the encryption. It is also a good example of how you can rebuild anything if there is total information preservation.</p>

<hr>

<h2 id="supplemental-information">Supplemental Information</h2>

<p>The logic I used in this challenge for the &quot;encryption&quot; is a variation of a <a href="https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function">FNV-1a</a> non-cryptographic hashing function that I learned of while reviewing source code for a popular video game written in C#: <sup id="cite_note-1"><a href="#cite_ref-1">[1]</a></sup></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">public <span style="color:#66d9ef">static</span> ulong <span style="color:#a6e22e">Hash</span>(string input)
    {
            ulong num <span style="color:#f92672">=</span> <span style="color:#ae81ff">14695981039346656037</span>;
            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; index <span style="color:#f92672">&lt;</span> input.Length; <span style="color:#f92672">++</span>index)
                num <span style="color:#f92672">=</span> (ulong)(((<span style="color:#66d9ef">long</span>)num <span style="color:#f92672">^</span> (<span style="color:#66d9ef">long</span>)input[index]) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1099511628211L</span>);
            num <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xFFFFFFFFFFFFFFF</span>;
            <span style="color:#66d9ef">return</span> num;
    }</code></pre></div>
<p>This function was used in the game code to hash asset names. Looking at this original function you will notice it uses an <em>AND</em> operator as it's final <a href="https://en.wikipedia.org/wiki/Bitwise_operation">Bitwise Operation</a>. This is used for <a href="https://en.wikipedia.org/wiki/Mask_(computing)#Hash_tables">Bitmasking</a> and controls the length of the output hash. This would have discarded bits and prevented us from being able to reverse the hash. I replaced the <em>AND</em> operation with an <em>XOR</em> operation in the challenge function. This allowed us to reverse the hash due to it's <a href="https://en.wikipedia.org/wiki/Associative_property#Definition">Associative Property</a>. The <em>AND</em> operation is a <a href="https://en.wikipedia.org/wiki/Logical_conjunction">Logical Conjunction</a> bitwise operation. Looking at the Truth Table for this operation you can see that it is not always possible to reconstruct <span  class="math">\(p\)</span>, given <span  class="math">\(q\)</span> and <span  class="math">\(p\&q\)</span>. <sup id="cite_note-2"><a href="#cite_ref-2">[2]</a></sup></p>

<blockquote>
<p><em>Note: This image uses the &quot;<strong>^</strong>&quot; character in place of an &quot;<strong>&amp;</strong>&quot;, but it still represents an <strong>AND</strong> operation.</em></p>
</blockquote>

<p><figure><img src="/blog/images/plastic_preservation/logical_conjunction.png#center" alt="truth_table"></figure></p>

<p>If we substitute <em>T</em> with <em>1</em>, and <em>F</em> with <em>0</em> we get bitwise operations.</p>

<p><figure><img src="/blog/images/plastic_preservation/bitwise.png#center" alt="bitwise"></figure></p>

<p>As you can see, we cannot simply compute the operation in reverse to reproduce the first value - it does not have an  Associative Property. The <em>AND</em> operation is <a href="https://stackoverflow.com/questions/2566225/how-to-reverse-bitwise-and-in-c#2566235">destructive</a> - it throws information away. Let's compare this to the Truth Table for the <a href="https://en.wikipedia.org/wiki/Exclusive_or">Exclusive Disjunction</a> <em>XOR</em> operation that we replaced it with, which has the Associative Property. <sup id="cite_note-3"><a href="#cite_ref-3">[3]</a></sup></p>

<p><figure><img src="/blog/images/plastic_preservation/exclusive_disjunction.png#center" alt="truth_table"></figure></p>

<p>It is clear that every operation can be computed both forward and backward. In order to make this function reversible for the challenge I had to remove the logical <em>AND</em>, and replace it with a non-destructive <em>XOR</em> operation to retain total information preservation, hence the name given to this challenge.</p>

<hr>

<h4 id="references">References:</h4>

<ol>
<li><sup id="cite_ref-1"><a href="#cite_note-1">^</a></sup> Landon, C. N. <a href="http://www.isthe.com/chongo/tech/comp/fnv/index.html#FNV-1a">&quot;FNV Hash&quot;</a></li>
<li><sup id="cite_ref-2"><a href="#cite_note-2">^</a></sup> Wikipedia. <a href="https://en.wikipedia.org/wiki/Truth_table#Logical_conjunction_(AND)">&quot;Truth Table; Logical Conjunction&quot;</a></li>
<li><sup id="cite_ref-3"><a href="#cite_note-3">^</a></sup> Wikipedia. <a href="https://en.wikipedia.org/wiki/Truth_table#Exclusive_disjunction">&quot;Truth Table; Exclusive Disjunction&quot;</a></li>
</ol>

<hr>

    </section>
</article>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "plasticuproject-github-io-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



        
            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://www.hackthebox.eu/profile/32882">
        <i class="fa fa-cube"></i>
    </a>
    
    <a class="symbol" href="https://gchq.github.io/CyberChef/#recipe=From_Base64%28%27A-Za-z0-9%2B/%3D%27,true%29&amp;input=Y0d4aGMzUnBZM1Z3Y205cVpXTjBRSEJ0TG0xbA">
        <i class="fa fa-envelope"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/plasticuproject">
        <i class="fa fa-github"></i>
    </a>
    
    <a class="symbol" href="https://www.linkedin.com/in/plasticuproject-b41a6b126">
        <i class="fa fa-linkedin"></i>
    </a>
    


</div>

    
    <p class="small">
    
        © Copyright 2020 plasticuproject
    
    </p>
</footer>

        
    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://plasticuproject.github.io/blog/js/main.js"></script>
<script src="https://plasticuproject.github.io/blog/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166142607-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
